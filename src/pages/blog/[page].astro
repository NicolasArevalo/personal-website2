---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths({ paginate }) {
  const posts = await getCollection('blog');
  const sortedPosts = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
  
  // We skip the first 10 because they are shown on index.astro,
  // but to keep math simple with built-in paginate, we can just paginate all
  // and then the user can navigate. 
  // Wait, if index has 10, then /blog/2 should have the next 10.
  // Astro's paginate generates /blog/1, /blog/2, etc.
  return paginate(sortedPosts, { pageSize: 10 });
}

// All paginated data is passed on the "page" prop
const { page } = Astro.props;

const formatDate = (date) => {
  return date.toLocaleDateString('es-ES', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  }).toUpperCase();
};

// If they go to /blog/1, we might want to just redirect to / as it's the same content
// but for now we can render it or redirect.
if (page.currentPage === 1) {
  return Astro.redirect('/');
}
---

<BaseLayout title={`Entradas - Página ${page.currentPage}`}>
  <div class="container feed-container">
    <div class="header-with-back">
      <a href={page.url.prev === '/blog/1' ? '/' : page.url.prev} class="back-link">&larr; Entradas más recientes</a>
      <h3 class="section-label">PÁGINA {page.currentPage} DE {page.lastPage}</h3>
    </div>
    <hr class="divider" />

    <div class="notes-list">
      {page.data.map(post => (
        <article class="note-card">
          <a href={`/blog/${post.slug}`} class="note-link-wrapper">
            <div class="note-date">
              <time datetime={post.data.date.toISOString()}>
                {formatDate(post.data.date)}
              </time>
            </div>
            <h2>{post.data.title}</h2>
            {post.data.description && <p class="note-excerpt">{post.data.description}</p>}
            <span class="read-more">Leer más &gt;</span>
          </a>
        </article>
      ))}
    </div>

    <div class="pagination">
      {page.url.prev ? (
        <a href={page.url.prev === '/blog/1' ? '/' : page.url.prev} class="pagination-link">&larr; Entradas más recientes</a>
      ) : (
        <span></span>
      )}
      {page.url.next ? (
        <a href={page.url.next} class="pagination-link">Entradas anteriores &rarr;</a>
      ) : (
        <span></span>
      )}
    </div>
  </div>
</BaseLayout>

<style>
  .feed-container {
    max-width: 650px;
    padding-top: 2rem;
  }
  
  .header-with-back {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .back-link {
    font-family: var(--font-body);
    color: var(--text-tertiary);
    font-size: 0.95rem;
    transition: color 0.2s, text-shadow 0.2s;
  }

  .back-link:hover {
    color: var(--text-primary);
    text-shadow: 0 0 10px rgba(147, 51, 234, 0.2);
  }

  .section-label {
    font-family: var(--font-body);
    font-size: 0.75rem;
    color: var(--text-tertiary);
    letter-spacing: 0.1em;
    font-weight: 500;
    margin: 0;
    text-transform: uppercase;
  }

  .divider {
    border: none;
    border-top: 1px solid var(--border-color);
    margin-bottom: 3rem;
  }

  .notes-list {
    display: flex;
    flex-direction: column;
  }

  .note-card {
    padding-bottom: 3rem;
    margin-bottom: 3rem;
    border-bottom: 1px solid var(--border-color);
  }

  .note-card:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  .note-link-wrapper {
    display: block;
    text-decoration: none;
    color: inherit;
    transition: none;
    text-shadow: none;
  }
  
  .note-link-wrapper:hover {
    color: inherit;
    text-shadow: none;
  }

  .note-date {
    font-family: var(--font-body);
    font-size: 0.8rem;
    color: var(--text-tertiary); /* Gray date to not stand out */
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
    transition: color 0.2s ease;
  }

  .note-card h2 {
    font-size: 2.2rem;
    margin-bottom: 1rem;
    font-weight: 400;
    letter-spacing: -0.02em;
    color: var(--text-primary);
    transition: color 0.2s ease, text-shadow 0.2s ease;
  }

  .note-excerpt {
    color: var(--text-secondary);
    font-size: 1.05rem;
    line-height: 1.6;
    margin-bottom: 1.5rem;
    font-weight: 400;
    transition: color 0.2s ease;
  }

  .read-more {
    font-family: var(--font-body);
    font-size: 0.95rem;
    color: var(--text-tertiary);
    transition: color 0.2s ease, text-shadow 0.2s ease;
  }

  /* GROUP HOVER EFFECT */
  .note-link-wrapper:hover h2,
  .note-link-wrapper:hover .read-more {
    color: var(--accent-color);
    text-shadow: 0 0 10px rgba(147, 51, 234, 0.4);
  }

  .pagination {
    display: flex;
    justify-content: space-between;
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
  }

  .pagination-link {
    font-family: var(--font-body);
    font-size: 1.1rem;
    color: var(--text-secondary);
    transition: color 0.2s ease, text-shadow 0.2s ease;
  }

  .pagination-link:hover {
    color: var(--accent-color);
    text-shadow: 0 0 10px rgba(147, 51, 234, 0.4);
  }
</style>
